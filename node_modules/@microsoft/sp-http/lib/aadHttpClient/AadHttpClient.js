import { Validate } from '@microsoft/sp-core-library';
import { fetchProviderServiceKey } from '../httpClient/FetchProvider';
import HttpClientResponse from '../httpClient/HttpClientResponse';
import AadTokenProviders from '../oauthTokenProvider/AadTokenProviders';
import HttpClientHelper from '../httpClient/HttpClientHelper';
import { predefinedConfigurations } from './AadHttpClientConfiguration';
var AadHttpClient =  (function () {
    function AadHttpClient(serviceScope, resourceEndpoint, options) {
        var _this = this;
        Validate.isNotNullOrUndefined(serviceScope, 'serviceScope');
        Validate.isNotNullOrUndefined(resourceEndpoint, 'resourceUrl');
        this._resourceUrl = resourceEndpoint;
        this._serviceScope = serviceScope;
        this._aadTokenProvider = options && options.tokenProvider || AadTokenProviders.configurable;
        this._aadTokenConfiguration = options && options.configuration;
        serviceScope.whenFinished(function () {
            _this._fetchProvider = serviceScope.consume(fetchProviderServiceKey);
        });
    }
    AadHttpClient.prototype.fetch = function (url, configuration, options) {
        var _this = this;
        var tokenFetchPromise = this._aadTokenConfiguration ?
            this._aadTokenProvider._getTokenInternal(this._resourceUrl, this._aadTokenConfiguration) :
            this._aadTokenProvider.getToken(this._resourceUrl);
        return tokenFetchPromise.then(function (token) {
            if (!options.headers) {
                options.headers = new Headers();
            }
            else {
                options.headers = new Headers(options.headers);
            }
            options.headers.append('Authorization', 'Bearer ' + token);
            return HttpClientHelper.fetchCore(configuration, new Request(url, options), _this._serviceScope, _this._fetchProvider, AadHttpClient._className);
        }).then(function (value) {
            return new HttpClientResponse(value);
        });
    };
    AadHttpClient.prototype.get = function (url, configuration, options) {
        return this.fetch(url, configuration, HttpClientHelper.overrideHttpMethod(options, 'GET'));
    };
    AadHttpClient.prototype.post = function (url, configuration, options) {
        return this.fetch(url, configuration, HttpClientHelper.overrideHttpMethod(options, 'POST'));
    };
    AadHttpClient.configurations = predefinedConfigurations;
    AadHttpClient._className = 'AadHttpClient';
    return AadHttpClient;
}());
export default AadHttpClient;
