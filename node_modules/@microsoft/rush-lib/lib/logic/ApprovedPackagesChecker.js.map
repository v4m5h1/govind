{"version":3,"file":"ApprovedPackagesChecker.js","sourceRoot":"","sources":["../../src/logic/ApprovedPackagesChecker.ts"],"names":[],"mappings":";AAAA,4FAA4F;AAC5F,2DAA2D;;AAE3D,oEAAyE;AAMzE,MAAa,uBAAuB;IAClC;;;;;;;OAOG;IACI,MAAM,CAAC,kBAAkB,CAAC,iBAAoC;QACnE,MAAM,sBAAsB,GAA2B,iBAAiB,CAAC,sBAAsB,CAAC;QAChG,IAAI,CAAC,sBAAsB,CAAC,OAAO,EAAE;YACnC,OAAO;SACR;QAED,KAAK,MAAM,WAAW,IAAI,iBAAiB,CAAC,QAAQ,EAAE;YACpD,MAAM,WAAW,GAAiB,WAAW,CAAC,WAAW,CAAC;YAE1D,uBAAuB,CAAC,oBAAoB,CAAC,WAAW,CAAC,YAAY,EACnE,sBAAsB,EAAE,WAAW,CAAC,CAAC;YACvC,uBAAuB,CAAC,oBAAoB,CAAC,WAAW,CAAC,oBAAoB,EAC3E,sBAAsB,EAAE,WAAW,CAAC,CAAC;YACvC,uBAAuB,CAAC,oBAAoB,CAAC,WAAW,CAAC,eAAe,EACtE,sBAAsB,EAAE,WAAW,CAAC,CAAC;SACxC;QAED,sBAAsB,CAAC,uBAAuB,CAAC,UAAU,EAAE,CAAC;QAC5D,sBAAsB,CAAC,0BAA0B,CAAC,UAAU,EAAE,CAAC;IACjE,CAAC;IAEO,MAAM,CAAC,oBAAoB,CAAC,YAAmD,EACrF,sBAA8C,EAAE,WAAqC;QAErF,IAAI,YAAY,EAAE;YAChB,KAAK,MAAM,WAAW,IAAI,MAAM,CAAC,IAAI,CAAC,YAAY,CAAC,EAAE;gBACnD,MAAM,KAAK,GAAW,+BAAW,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC;gBAExD,4EAA4E;gBAC5E,IAAI,CAAC,sBAAsB,CAAC,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE;oBACvD,oDAAoD;oBAEpD,sFAAsF;oBACtF,2CAA2C;oBAC3C,IAAI,sBAAsB,CAAC,0BAA0B,CAAC,aAAa,CAAC,WAAW,CAAC,EAAE;wBAChF,sBAAsB,CAAC,0BAA0B;6BAC9C,kBAAkB,CAAC,WAAW,EAAE,WAAW,CAAC,cAAc,CAAC,CAAC;qBAChE;yBAAM;wBACL,sBAAsB,CAAC,uBAAuB;6BAC3C,kBAAkB,CAAC,WAAW,EAAE,WAAW,CAAC,cAAc,CAAC,CAAC;qBAChE;iBACF;aACF;SACF;IACH,CAAC;CACF;AAtDD,0DAsDC","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport { IPackageJson, PackageName } from '@microsoft/node-core-library';\r\n\r\nimport { ApprovedPackagesPolicy } from '../api/ApprovedPackagesPolicy';\r\nimport { RushConfiguration } from '../api/RushConfiguration';\r\nimport { RushConfigurationProject } from '../api/RushConfigurationProject';\r\n\r\nexport class ApprovedPackagesChecker {\r\n  /**\r\n   * Examines the current dependencies for the projects specified in RushConfiguration,\r\n   * and then adds them to the 'browser-approved-packages.json' and\r\n   * 'nonbrowser-approved-packages.json' config files.  If these files don't exist,\r\n   * they will be created.\r\n   *\r\n   * If the \"approvedPackagesPolicy\" feature is not enabled, then no action is taken.\r\n   */\r\n  public static rewriteConfigFiles(rushConfiguration: RushConfiguration): void {\r\n    const approvedPackagesPolicy: ApprovedPackagesPolicy = rushConfiguration.approvedPackagesPolicy;\r\n    if (!approvedPackagesPolicy.enabled) {\r\n      return;\r\n    }\r\n\r\n    for (const rushProject of rushConfiguration.projects) {\r\n      const packageJson: IPackageJson = rushProject.packageJson;\r\n\r\n      ApprovedPackagesChecker._collectDependencies(packageJson.dependencies,\r\n        approvedPackagesPolicy, rushProject);\r\n      ApprovedPackagesChecker._collectDependencies(packageJson.optionalDependencies,\r\n        approvedPackagesPolicy, rushProject);\r\n      ApprovedPackagesChecker._collectDependencies(packageJson.devDependencies,\r\n        approvedPackagesPolicy, rushProject);\r\n    }\r\n\r\n    approvedPackagesPolicy.browserApprovedPackages.saveToFile();\r\n    approvedPackagesPolicy.nonbrowserApprovedPackages.saveToFile();\r\n  }\r\n\r\n  private static _collectDependencies(dependencies: { [key: string]: string } | undefined,\r\n    approvedPackagesPolicy: ApprovedPackagesPolicy, rushProject: RushConfigurationProject): void {\r\n\r\n    if (dependencies) {\r\n      for (const packageName of Object.keys(dependencies)) {\r\n        const scope: string = PackageName.getScope(packageName);\r\n\r\n        // Make sure the scope isn't something like \"@types\" which should be ignored\r\n        if (!approvedPackagesPolicy.ignoredNpmScopes.has(scope)) {\r\n          // Yes, add it to the list if it's not already there\r\n\r\n          // By default we put everything in the browser file.  But if it already appears in the\r\n          // non-browser file, then use that instead.\r\n          if (approvedPackagesPolicy.nonbrowserApprovedPackages.getItemByName(packageName)) {\r\n            approvedPackagesPolicy.nonbrowserApprovedPackages\r\n              .addOrUpdatePackage(packageName, rushProject.reviewCategory);\r\n          } else {\r\n            approvedPackagesPolicy.browserApprovedPackages\r\n              .addOrUpdatePackage(packageName, rushProject.reviewCategory);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n"]}