"use strict";
/**
 * @file uploadFilesToAzure.ts
 * @Copyright (c) Microsoft Corporation.  All rights reserved.
 *
 * Uploads a list of files to an Azure Blob Service instance
 */
Object.defineProperty(exports, "__esModule", { value: true });
const uploadFileToAzure_1 = require("./uploadFileToAzure");
function uploadFilesToAzure(blobService, containerName, files, log = console.log) {
    log(`Uploading [${files.length}] files...`);
    return batchPromise(50, files, log, (file) => {
        return uploadFileToAzure_1.default(blobService, containerName, file.localPath, file.azurePath, log);
    }).then(() => {
        return blobService;
    });
}
exports.default = uploadFilesToAzure;
/**
 * Helper function to run promises in batches
 * @param batchSize - the number of promises to run at a single time
 * @param items - the list of items that are inputs to the createPromise function
 * @param log - a helper function for performing logging
 * @param createPromise - a function which takes an item and returns a promise to do something
 */
function batchPromise(batchSize, items, log, createPromise) {
    return Promise.resolve(items)
        .then((arr) => {
        let batchNumber = 0;
        return arr
            // create a list of batches and empty arrays
            .map((item, index) => {
            // if this is the start of a batch boundary, take the next batchSize elements
            // otherwise return an empty array that will be filtered in the next step
            return index % batchSize === 0
                ? arr.slice(index, index + batchSize)
                : [];
        })
            // remove any of the empty arrays
            .filter((batch) => {
            return batch.length > 0;
        })
            // turn the array of items into callbacks which create promises
            .map((batch) => {
            return () => {
                return Promise.all(batch.map(createPromise));
            };
        })
            // then create the serial promise chain
            .reduce((chain, work) => {
            return chain
                .then(work)
                .then((data) => {
                log(`Finished batch #${++batchNumber}`);
            });
        }, Promise.resolve(undefined));
    });
}
exports.batchPromise = batchPromise;
//# sourceMappingURL=uploadFilesToAzure.js.map