{"version":3,"file":"VersionControl.js","sourceRoot":"","sources":["../../src/utilities/VersionControl.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as child_process from 'child_process';\r\n\r\nexport class VersionControl {\r\n  public static getChangedFolders(targetBranch?: string): Array<string | undefined> | undefined {\r\n    const branchName: string = targetBranch ? targetBranch : 'origin/master';\r\n    const output: string | undefined = child_process.execSync(`git diff ${branchName}... --dirstat=files,0`)\r\n      .toString();\r\n    return output.split('\\n').map(s => {\r\n      if (s) {\r\n        const delimiterIndex: number = s.indexOf('%');\r\n        if (delimiterIndex > 0 && delimiterIndex + 1 < s.length) {\r\n          return s.substring(delimiterIndex + 1).trim();\r\n        }\r\n      }\r\n      return undefined;\r\n    });\r\n  }\r\n\r\n  public static getChangedFiles(prefix?: string, targetBranch?: string): string[] {\r\n    const branchName: string = targetBranch ? targetBranch : 'origin/master';\r\n    const output: string = child_process\r\n      .execSync(`git diff ${branchName}... --name-only --no-renames --diff-filter=A`)\r\n      .toString();\r\n    const regex: RegExp | undefined = prefix ? new RegExp(`^${prefix}`, 'i') : undefined;\r\n    return output.split('\\n').map(s => {\r\n      if (s) {\r\n        const trimmedLine: string = s.trim();\r\n        if (regex && trimmedLine.match(regex)) {\r\n          return trimmedLine;\r\n        }\r\n      }\r\n      return undefined;\r\n    }).filter(s => {\r\n      return s && s.length > 0;\r\n    }) as string[];\r\n  }\r\n\r\n  /**\r\n   * Gets the remote master branch that maps to the provided repository url.\r\n   * This method is used by 'Rush change' to find the default remote branch to compare against.\r\n   * If repository url is not provided or if there is no match, returns the default remote\r\n   * master branch 'origin/master'.\r\n   * If there are more than one matches, returns the first remote's master branch.\r\n   *\r\n   * @param repositoryUrl - repository url\r\n   */\r\n  public static getRemoteMasterBranch(repositoryUrl?: string): string {\r\n    const defaultRemote: string = 'origin';\r\n    const defaultMaster: string = 'origin/master';\r\n    let useDefault: boolean = false;\r\n    let matchingRemotes: string[] = [];\r\n\r\n    if (!repositoryUrl) {\r\n      useDefault = true;\r\n    } else {\r\n      const output: string = child_process\r\n      .execSync(`git remote`)\r\n      .toString();\r\n      matchingRemotes = output.split('\\n').filter(remoteName => {\r\n        if (remoteName) {\r\n          const remoteUrl: string = child_process.execSync(`git remote get-url ${remoteName}`)\r\n            .toString()\r\n            .trim();\r\n          if (remoteName === defaultRemote && remoteUrl === repositoryUrl) {\r\n            useDefault = true;\r\n          }\r\n          return remoteUrl === repositoryUrl;\r\n        }\r\n        return false;\r\n      });\r\n    }\r\n\r\n    if (useDefault) {\r\n      return defaultMaster;\r\n    } else if (matchingRemotes.length > 0) {\r\n      if (matchingRemotes.length > 1) {\r\n        console.log(`More than one remotes match the repository url. Use the first remote.`);\r\n      }\r\n      return `${matchingRemotes[0]}/master`;\r\n    }\r\n    // For backward-compatible\r\n    return defaultMaster;\r\n  }\r\n\r\n  public static hasUncommittedChanges(): boolean {\r\n    return VersionControl.getUncommittedChanges().length > 0;\r\n  }\r\n\r\n  /**\r\n   * The list of files changed but not commited\r\n   */\r\n  public static getUncommittedChanges(): ReadonlyArray<string> {\r\n    const changes: string[] = [];\r\n    changes.push(...VersionControl._getUntrackedChanges());\r\n    changes.push(...VersionControl._getDiffOnHEAD());\r\n\r\n    return changes.filter(change => {\r\n      return change.trim().length > 0;\r\n    });\r\n  }\r\n\r\n  private static _getUntrackedChanges(): string[] {\r\n    const output: string = child_process\r\n      .execSync(`git ls-files --exclude-standard --others`)\r\n      .toString();\r\n    return output.trim().split('\\n');\r\n  }\r\n\r\n  private static _getDiffOnHEAD(): string[] {\r\n    const output: string = child_process\r\n      .execSync(`git diff HEAD --name-only`)\r\n      .toString();\r\n    return output.trim().split('\\n');\r\n  }\r\n}\r\n"]}